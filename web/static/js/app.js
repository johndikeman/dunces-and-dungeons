// Generated by CoffeeScript 1.10.0
(function() {
  var fix, is_choice, is_input, is_player_info, make_choice_form, make_input_form, process_output, reset_movables, send_positions, update_player_ui;

  $(document).ready(function() {
    $('.movable').draggable({
      stop: (function() {
        return send_positions();
      })
    });
    $('.resizable').resizable();
    reset_movables(window.positions);
    return process_output(window.messages);
  });

  reset_movables = function(positions) {
    var a, element, i, ind, l, len, ref, results;
    console.log(positions);
    if (positions !== null) {
      ind = 0;
      ref = positions.split('%');
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        a = ref[i];
        if (a !== '') {
          l = a.split('|');
          element = $("\#" + l[0]);
          results.push(element.offset({
            top: l[1],
            left: l[2]
          }));
        } else {
          results.push(void 0);
        }
      }
      return results;
    }
  };

  send_positions = function() {
    var a, i, movable, one_movable_object, payload, pos, ref;
    movable = $('.movable');
    payload = '';
    for (a = i = 0, ref = movable.length; 0 <= ref ? i < ref : i > ref; a = 0 <= ref ? ++i : --i) {
      one_movable_object = $(movable[a]);
      pos = one_movable_object.position();
      payload += one_movable_object[0].id + "|" + pos.top + "|" + pos.left + "%";
    }
    return $.post('/positioning', payload);
  };

  is_choice = function(data) {
    if (data.slice(0, 6) === 'CHOICE') {
      return true;
    }
    return false;
  };

  make_choice_form = function(data) {
    var a, form, i, len, options;
    console.log(window.choiceskips);
    if (window.choiceskips === 0) {
      options = data.slice(6).split('|');
      form = "<form id=\"ch\" action=\"/choice\" method='post'>";
      for (i = 0, len = options.length; i < len; i++) {
        a = options[i];
        if (a !== '' && a !== void 0) {
          form += "<input type=\"radio\" name='makechoice' value=\"" + data + "%" + a[0] + "\">" + a.slice(1) + "<br>";
        }
      }
      form += "<input type=\"submit\" value=\"choose!\">";
      form += "</form>";
      return $('#choiceholder').append(form);
    } else {
      return window.choiceskips -= 1;
    }
  };

  is_input = function(message) {
    if (message.slice(0, 5) === 'INPUT') {
      return true;
    } else {
      return false;
    }
  };

  make_input_form = function(message) {
    var form;
    if (window.choiceskips === 0) {
      form = "<a>" + message.slice(5) + "</a><form id=\"ch\" action=\"/input\" method='post'>";
      form += "<input type=\"text\" name='input'><br><input type=\"submit\" value=\"choose!\"></form>";
      return $('#choiceholder').append(form);
    } else {
      return window.choiceskips -= 1;
    }
  };

  is_player_info = function(message) {
    if (message.slice(0, 10) === 'PLAYERINFO') {
      return true;
    } else {
      return false;
    }
  };

  update_player_ui = function(message) {
    var player_data;
    player_data = $.parseJSON(message.slice(10));
    console.log(player_data);
    $('#healthbar').html("health: " + player_data.hp);
    $('#xpbar').html("xp: " + player_data.xp);
    $('#playername').html(player_data.name + "'s stats");
    return $('#action_points').html("action points: " + player_data.action_points);
  };

  process_output = function(message) {
    var i, len, mes, results;
    results = [];
    for (i = 0, len = message.length; i < len; i++) {
      mes = message[i];
      if (is_choice(mes)) {
        results.push(make_choice_form(mes));
      } else if (is_input(mes)) {
        results.push(make_input_form(mes));
      } else if (is_player_info(mes)) {
        results.push(update_player_ui(mes));
      } else {
        results.push($('#main').append(mes + "<br>"));
      }
    }
    return results;
  };

  fix = function() {
    return alert('dicks');
  };

}).call(this);
